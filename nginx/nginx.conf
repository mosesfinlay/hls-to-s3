worker_processes auto;
error_log  /var/log/nginx/error.log warn;
events { worker_connections 1024; }

rtmp {
  server {
    listen 1935;
    chunk_size 4096;

    application live {
      live on;

      # HLS output
      hls on;
      hls_path /hls;
      hls_fragment ${HLS_FRAGMENT_SECONDS}s;
      hls_playlist_length ${HLS_PLAYLIST_SECONDS}s;
      hls_continuous on;
      hls_cleanup on;
      hls_nested on;   # /hls/STREAM_KEY/*.m3u8

      # optionally restrict publish by key pattern
      # allow publish ~^.+$;
    }
  }
}

http {
  include       mime.types;
  default_type  application/octet-stream;

  server {
    listen 80 default_server;

    # quick health/status
    location / {
      return 200 'nginx-rtmp alive\n';
      add_header Content-Type text/plain;
    }

    # browse HLS locally (your SG should block external 80 if you want it private)
    location /hls/ {
      types { application/vnd.apple.mpegurl m3u8; video/mp2t ts; }
      alias /hls/;
      add_header Cache-Control "no-store";
      autoindex on;
    }
  }
}
